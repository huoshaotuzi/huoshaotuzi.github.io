<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="通过 array_reduce 方法实现路由中间件的功能。"><meta name="keywords" content="PHP,FireRabbitEngine,Swoole"><meta name="author" content="火烧兔子"><meta name="copyright" content="火烧兔子"><title>从零开始搭建自己的Swoole框架（八）路由中间件 | 火兔博客</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="火兔博客" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">中间件的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">中间件的应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Laravel-%E4%B8%AD%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">Laravel 中的中间件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Laravel-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">Laravel 中间件的原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Laravel-%E6%BA%90%E7%A0%81"><span class="toc-number">4.1.</span> <span class="toc-text">Laravel 源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#array-reduce"><span class="toc-number">4.2.</span> <span class="toc-text">array_reduce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E6%9A%97%E5%8F%B7%E6%B8%B8%E6%88%8F"><span class="toc-number">4.3.</span> <span class="toc-text">对暗号游戏</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E6%A1%86%E6%9E%B6%E6%B7%BB%E5%8A%A0%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">为框架添加中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%8E%9F%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">中间件原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%9D%97"><span class="toc-number">5.2.</span> <span class="toc-text">优化路由模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%B7%BB%E5%8A%A0%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">5.3.</span> <span class="toc-text">路由添加中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E8%AF%B7%E6%B1%82%E4%B8%8E%E5%93%8D%E5%BA%94"><span class="toc-number">5.4.</span> <span class="toc-text">封装请求与响应</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%B1%BB"><span class="toc-number">5.5.</span> <span class="toc-text">中间件类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%80%BB%E8%BE%91"><span class="toc-number">5.6.</span> <span class="toc-text">中间件逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB"><span class="toc-number">5.7.</span> <span class="toc-text">添加映射关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">6.</span> <span class="toc-text">测试中间件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%AE%B0%E5%BD%95"><span class="toc-number">7.</span> <span class="toc-text">修改记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%85%8D%E7%BD%AE%E5%8C%96"><span class="toc-number">7.1.</span> <span class="toc-text">中间件配置化</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://i.loli.net/2021/05/02/JjR7MmfePax3oc2.jpg"></div><div class="author-info__name text-center">火烧兔子</div><div class="author-info__description text-center">这里是火兔博客，火兔兔的小窝。</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">62</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">24</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">17</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://i.loli.net/2021/05/02/61DLs9VHetxbq2n.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">火兔博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" target="_blank" rel="noopener" href="http://huotuyouxi.com">游戏博客</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">从零开始搭建自己的Swoole框架（八）路由中间件</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-02-12</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%9E%B6%E6%9E%84/">架构</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="中间件的概念"><a href="#中间件的概念" class="headerlink" title="中间件的概念"></a>中间件的概念</h2><p>中间件就是一种系统之间互相连接的“中间的一层”。</p>
<p>通俗的讲类似古代的关口，西游记里唐僧每到一个国家都要取得这个国家的“通关文凭”，如果没有通关文凭就无法离开国界。边关的守卫就可以理解为“中间件”，唐僧就是请求，如果没有通过文凭（即达不到某种要求）就会被拦截在关口。</p>
<p>也就是说，中间件的主要功能是“拦截不符合规范的请求”。</p>
<p>它就是一种 <code>if-else</code> 条件判断结构，如果……就……</p>
<p>比如要设计一个活动页面，只有今天晚上 9：00 到 10：00 这个时间段才会进入活动页，如果还不到 9 点就打开这个页面就会显示“活动还未开始”，如果是 10 点之后打开这个页面，就会显示“活动已结束”。</p>
<p>要实现这种功能十分简单，直接用 <code>if-else</code> 结构就可以了。</p>
<p>但是这种思想属于面向过程，在框架里可以将判断条件封装为“中间件”实现自动化处理请求，满足要求的就放过，不满足要求的就拦截下来，返回失败的处理。</p>
<h2 id="中间件的应用场景"><a href="#中间件的应用场景" class="headerlink" title="中间件的应用场景"></a>中间件的应用场景</h2><p>中间件即拦截不符合规范的请求，因此它能用的场景非常多。</p>
<p>例如规定了某个时间段开放、关闭的活动页面；</p>
<p>表单验证、用户登录状态验证等等。</p>
<p>总之，凡是能用“如果……就……”描述的，几乎都可以用中间件实现，因为它本身即是一种条件判断结构。</p>
<h2 id="Laravel-中的中间件"><a href="#Laravel-中的中间件" class="headerlink" title="Laravel 中的中间件"></a>Laravel 中的中间件</h2><p>Laravel 中的中间件的使用非常优雅！</p>
<p>创建一个中间件，用于验证用户是否登录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Http\Middleware;</span><br><span class="line"></span><br><span class="line">use Closure;</span><br><span class="line"></span><br><span class="line">class AuthCheck</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * Handle an incoming request.</span><br><span class="line">     *</span><br><span class="line">     * @param \Illuminate\Http\Request $request</span><br><span class="line">     * @param \Closure $next</span><br><span class="line">     * @return mixed</span><br><span class="line">     */</span><br><span class="line">    public function handle($request, Closure $next)</span><br><span class="line">    &#123;</span><br><span class="line">        // 判断用户是否登录状态，如果已登录则进入下一步</span><br><span class="line">        if (auth()-&gt;check()) &#123;</span><br><span class="line">            return $next($request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 如果未登录则返回提示页面的视图</span><br><span class="line">        $message = &#x27;用户未登录，无法操作，&lt;a href=&quot;#&quot;&gt;前往登录&lt;/a&gt;。&#x27;;</span><br><span class="line">        return $this-&gt;showErrorPage($message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public functio showErrorPage($message) &#123;</span><br><span class="line">        // ... 返回自定义视图页面</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后在 Kernel.php 中注册中间件，并且命名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected $routeMiddleware = [</span><br><span class="line">    &#x27;auth.check&#x27; =&gt; AuthCheck::class,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>最后只要在路由配置中为需要验证用户身份的路由加上中间件即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$router-&gt;middleware(&#x27;auth.check&#x27;)-&gt;get(&#x27;/user&#x27;, &#x27;UserController@index&#x27;)-&gt;name(&#x27;user.index&#x27;);</span><br></pre></td></tr></table></figure>

<p>只需如此简单的配置即可实现路由拦截。</p>
<h2 id="Laravel-中间件的原理"><a href="#Laravel-中间件的原理" class="headerlink" title="Laravel 中间件的原理"></a>Laravel 中间件的原理</h2><p>一个路由可以有很多中间件，只有满足所有中间件才让请求继续下去，否则就终端请求返回错误的结果。</p>
<p>看起来只需要一个 foreach 循环就能实现中间件了，用伪代码实现思路如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$flag = true;</span><br><span class="line"></span><br><span class="line">$conditions = [条件1, 条件2, 条件3];</span><br><span class="line"></span><br><span class="line">foreach ($conditions as $condition) &#123;</span><br><span class="line">    if($condition == false) &#123;</span><br><span class="line">        $flag = false;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($flag == true) &#123;</span><br><span class="line">    // 成功，进入下一步</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // 失败，返回失败页</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好像确实可以，但我出于好奇研究了一下 Laravel 的源码。</p>
<h3 id="Laravel-源码"><a href="#Laravel-源码" class="headerlink" title="Laravel 源码"></a>Laravel 源码</h3><p>在定义 Middleware 类的时候，我发现 Middleware 不需要继承任何框架的基类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Http\Middleware;</span><br><span class="line"></span><br><span class="line">use Closure;</span><br><span class="line"></span><br><span class="line">class AuthCheck</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * Handle an incoming request.</span><br><span class="line">     *</span><br><span class="line">     * @param \Illuminate\Http\Request $request</span><br><span class="line">     * @param \Closure $next</span><br><span class="line">     * @return mixed</span><br><span class="line">     */</span><br><span class="line">    public function handle($request, Closure $next)</span><br><span class="line">    &#123;</span><br><span class="line">        // 判断用户是否登录状态，如果已登录则进入下一步</span><br><span class="line">        if (auth()-&gt;check()) &#123;</span><br><span class="line">            return $next($request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 如果未登录则返回提示页面的视图</span><br><span class="line">        $message = &#x27;用户未登录，无法操作，&lt;a href=&quot;#&quot;&gt;前往登录&lt;/a&gt;。&#x27;;</span><br><span class="line">        return $this-&gt;showErrorPage($message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public functio showErrorPage($message) &#123;</span><br><span class="line">        // ... 返回自定义视图页面</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只是定义一个 handle 方法，一共接收两个参数，</p>
<p>一个是 Laravel 的 $request，另一个是闭包类型 $next。</p>
<p>如果请求验证成功，则直接返回闭包执行结果 <code>$next($request)</code>，</p>
<p>如果请求不符合要求，就自定义一个响应返回。</p>
<p>看来，玄机并不在 Middleware 的定义里。</p>
<p>基于 php-fpm 的框架入口文件基本上都是 index.php，</p>
<p>因此找到 Laravel 的入口文件在 public 目录下面，index.php 的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Laravel - A PHP Framework For Web Artisans</span><br><span class="line"> *</span><br><span class="line"> * @package  Laravel</span><br><span class="line"> * @author   Taylor Otwell &lt;taylor@laravel.com&gt;</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">define(&#x27;LARAVEL_START&#x27;, microtime(true));</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Register The Auto Loader</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| Composer provides a convenient, automatically generated class loader for</span><br><span class="line">| our application. We just need to utilize it! We&#x27;ll simply require it</span><br><span class="line">| into the script here so that we don&#x27;t have to worry about manual</span><br><span class="line">| loading any of our classes later on. It feels great to relax.</span><br><span class="line">|</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">require __DIR__.&#x27;/../vendor/autoload.php&#x27;;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Turn On The Lights</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| We need to illuminate PHP development, so let us turn on the lights.</span><br><span class="line">| This bootstraps the framework and gets it ready for use, then it</span><br><span class="line">| will load up this application so that we can run it and send</span><br><span class="line">| the responses back to the browser and delight our users.</span><br><span class="line">|</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">$app = require_once __DIR__.&#x27;/../bootstrap/app.php&#x27;;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Run The Application</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| Once we have the application, we can handle the incoming request</span><br><span class="line">| through the kernel, and send the associated response back to</span><br><span class="line">| the client&#x27;s browser allowing them to enjoy the creative</span><br><span class="line">| and wonderful application we have prepared for them.</span><br><span class="line">|</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br><span class="line"></span><br><span class="line">$kernel-&gt;terminate($request, $response);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里引入了一个文件，然后得到一个 $app 对象，接着调用 handle 方法执行响应事件，</p>
<p>然后就没有其他代码了，因此这个引入的 app.php 是关键所在：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$app = require_once __DIR__.&#x27;/../bootstrap/app.php&#x27;;</span><br></pre></td></tr></table></figure>

<p>找到 app.php 发现如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Create The Application</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| The first thing we will do is create a new Laravel application instance</span><br><span class="line">| which serves as the &quot;glue&quot; for all the components of Laravel, and is</span><br><span class="line">| the IoC container for the system binding all of the various parts.</span><br><span class="line">|</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">$app = new Illuminate\Foundation\Application(</span><br><span class="line">    $_ENV[&#x27;APP_BASE_PATH&#x27;] ?? dirname(__DIR__)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Bind Important Interfaces</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| Next, we need to bind some important interfaces into the container so</span><br><span class="line">| we will be able to resolve them when needed. The kernels serve the</span><br><span class="line">| incoming requests to this application from both the web and CLI.</span><br><span class="line">|</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Http\Kernel::class,</span><br><span class="line">    App\Http\Kernel::class</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Console\Kernel::class,</span><br><span class="line">    App\Console\Kernel::class</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Debug\ExceptionHandler::class,</span><br><span class="line">    App\Exceptions\Handler::class</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Return The Application</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| This script returns the application instance. The instance is given to</span><br><span class="line">| the calling script so we can separate the building of the instances</span><br><span class="line">| from the actual running of the application and sending responses.</span><br><span class="line">|</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">return $app;</span><br></pre></td></tr></table></figure>

<p>这里是注册服务容器的地方，服务容器 Laravel 实例化类的一种设计模式，</p>
<p>具体的原理我也没有搞懂，只要知道这是一个“注册和实例化类”的地方就可以了。</p>
<p>跟 HTTP 请求相关的部分：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Http\Kernel::class,</span><br><span class="line">    App\Http\Kernel::class</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>按住 Ctrl 点击 <code>App\Http\Kernel::class</code> 可以跳转到类定义的地方，</p>
<p>结果发现跳转到中间件配置的地方了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Http;</span><br><span class="line"></span><br><span class="line">use Illuminate\Foundation\Http\Kernel as HttpKernel;</span><br><span class="line"></span><br><span class="line">class Kernel extends HttpKernel</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * The application&#x27;s global HTTP middleware stack.</span><br><span class="line">     *</span><br><span class="line">     * These middleware are run during every request to your application.</span><br><span class="line">     *</span><br><span class="line">     * @var array</span><br><span class="line">     */</span><br><span class="line">    protected $middleware = [</span><br><span class="line">        // \App\Http\Middleware\TrustHosts::class,</span><br><span class="line">        \App\Http\Middleware\TrustProxies::class,</span><br><span class="line">        \Fruitcake\Cors\HandleCors::class,</span><br><span class="line">        \App\Http\Middleware\CheckForMaintenanceMode::class,</span><br><span class="line">        \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,</span><br><span class="line">        \App\Http\Middleware\TrimStrings::class,</span><br><span class="line">        \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The application&#x27;s route middleware groups.</span><br><span class="line">     *</span><br><span class="line">     * @var array</span><br><span class="line">     */</span><br><span class="line">    protected $middlewareGroups = [</span><br><span class="line">        &#x27;web&#x27; =&gt; [</span><br><span class="line">            \App\Http\Middleware\EncryptCookies::class,</span><br><span class="line">            \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,</span><br><span class="line">            \Illuminate\Session\Middleware\StartSession::class,</span><br><span class="line">            // \Illuminate\Session\Middleware\AuthenticateSession::class,</span><br><span class="line">            \Illuminate\View\Middleware\ShareErrorsFromSession::class,</span><br><span class="line">            \App\Http\Middleware\VerifyCsrfToken::class,</span><br><span class="line">            \Illuminate\Routing\Middleware\SubstituteBindings::class,</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        &#x27;api&#x27; =&gt; [</span><br><span class="line">//            &#x27;throttle:60,1&#x27;,</span><br><span class="line">            \Illuminate\Routing\Middleware\SubstituteBindings::class,</span><br><span class="line">        ],</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The application&#x27;s route middleware.</span><br><span class="line">     *</span><br><span class="line">     * These middleware may be assigned to groups or used individually.</span><br><span class="line">     *</span><br><span class="line">     * @var array</span><br><span class="line">     */</span><br><span class="line">    protected $routeMiddleware = [</span><br><span class="line">        &#x27;auth&#x27; =&gt; \App\Http\Middleware\Authenticate::class,</span><br><span class="line">        &#x27;auth.basic&#x27; =&gt; \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看来离想要找到的结果不远了，这个配置也没什么奇怪的地方，</p>
<p>接着发现这个类继承了另一个类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use Illuminate\Foundation\Http\Kernel as HttpKernel;</span><br></pre></td></tr></table></figure>

<p>于是我们继续前往这个类，发现这个类有很多方法，</p>
<p>我就直接截取关键部分了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Handle an incoming HTTP request.</span><br><span class="line"> *</span><br><span class="line"> * @param  \Illuminate\Http\Request  $request</span><br><span class="line"> * @return \Illuminate\Http\Response</span><br><span class="line"> */</span><br><span class="line">public function handle($request)</span><br><span class="line">&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        $request-&gt;enableHttpMethodParameterOverride();</span><br><span class="line"></span><br><span class="line">        $response = $this-&gt;sendRequestThroughRouter($request);</span><br><span class="line">    &#125; catch (Throwable $e) &#123;</span><br><span class="line">        $this-&gt;reportException($e);</span><br><span class="line"></span><br><span class="line">        $response = $this-&gt;renderException($request, $e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $this-&gt;app[&#x27;events&#x27;]-&gt;dispatch(</span><br><span class="line">        new RequestHandled($request, $response)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    return $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handle 方法？也就是说最开始入口文件执行的便是这个方法了。</p>
<p>根据注释：Handle an incoming HTTP request</p>
<p>可以知道这里确实是处理进来请求的地方。</p>
<p>第一行执行的方法：<code>enableHttpMethodParameterOverride</code>，即 Laravel 重写请求方法的地方，</p>
<p>在 Laravel 除了 GET 和 POST 之外，还定义了 PUT、DELETE 等方法，</p>
<p>这里就是判断 <code>_method</code> 变量生成特殊请求方法的地方。</p>
<p>接着查看 <code>sendRequestThroughRouter</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Send the given request through the middleware / router.</span><br><span class="line"> *</span><br><span class="line"> * @param  \Illuminate\Http\Request  $request</span><br><span class="line"> * @return \Illuminate\Http\Response</span><br><span class="line"> */</span><br><span class="line">protected function sendRequestThroughRouter($request)</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;app-&gt;instance(&#x27;request&#x27;, $request);</span><br><span class="line"></span><br><span class="line">    Facade::clearResolvedInstance(&#x27;request&#x27;);</span><br><span class="line"></span><br><span class="line">    $this-&gt;bootstrap();</span><br><span class="line"></span><br><span class="line">    return (new Pipeline($this-&gt;app))</span><br><span class="line">                -&gt;send($request)</span><br><span class="line">                -&gt;through($this-&gt;app-&gt;shouldSkipMiddleware() ? [] : $this-&gt;middleware)</span><br><span class="line">                -&gt;then($this-&gt;dispatchToRouter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的代码应该就是我想要找的了，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">return (new Pipeline($this-&gt;app))</span><br><span class="line">                -&gt;send($request)</span><br><span class="line">                -&gt;through($this-&gt;app-&gt;shouldSkipMiddleware() ? [] : $this-&gt;middleware)</span><br><span class="line">                -&gt;then($this-&gt;dispatchToRouter());</span><br></pre></td></tr></table></figure>

<p>send 方法非常简单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * Set the object being sent through the pipeline.</span><br><span class="line"> *</span><br><span class="line"> * @param  mixed  $passable</span><br><span class="line"> * @return $this</span><br><span class="line"> */</span><br><span class="line">public function send($passable)</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;passable = $passable;</span><br><span class="line"></span><br><span class="line">    return $this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并不是处理中间件的逻辑，接着看 through：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Set the array of pipes.</span><br><span class="line"> *</span><br><span class="line"> * @param  array|mixed  $pipes</span><br><span class="line"> * @return $this</span><br><span class="line"> */</span><br><span class="line">public function through($pipes)</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;pipes = is_array($pipes) ? $pipes : func_get_args();</span><br><span class="line"></span><br><span class="line">    return $this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也不是，最后的 then：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Run the pipeline with a final destination callback.</span><br><span class="line"> *</span><br><span class="line"> * @param  \Closure  $destination</span><br><span class="line"> * @return mixed</span><br><span class="line"> */</span><br><span class="line">public function then(Closure $destination)</span><br><span class="line">&#123;</span><br><span class="line">    $pipeline = array_reduce(</span><br><span class="line">        array_reverse($this-&gt;pipes()), $this-&gt;carry(), $this-&gt;prepareDestination($destination)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    return $pipeline($this-&gt;passable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也只有短短数行的代码，难道最后也没找到中间件的实现逻辑？</p>
<p>而且……这个 <code>array_reduce</code> 是什么鬼？</p>
<p>仔细的研究了一番，发现这里的代码虽然只有 4 行，可真的不简单！</p>
<p>其中，最关键的部分是这个叫做 carry 的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Get a Closure that represents a slice of the application onion.</span><br><span class="line"> *</span><br><span class="line"> * @return \Closure</span><br><span class="line"> */</span><br><span class="line">protected function carry()</span><br><span class="line">&#123;</span><br><span class="line">    return function ($stack, $pipe) &#123;</span><br><span class="line">        return function ($passable) use ($stack, $pipe) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                if (is_callable($pipe)) &#123;</span><br><span class="line">                    // If the pipe is a callable, then we will call it directly, but otherwise we</span><br><span class="line">                    // will resolve the pipes out of the dependency container and call it with</span><br><span class="line">                    // the appropriate method and arguments, returning the results back out.</span><br><span class="line">                    return $pipe($passable, $stack);</span><br><span class="line">                &#125; elseif (! is_object($pipe)) &#123;</span><br><span class="line">                    [$name, $parameters] = $this-&gt;parsePipeString($pipe);</span><br><span class="line"></span><br><span class="line">                    // If the pipe is a string we will parse the string and resolve the class out</span><br><span class="line">                    // of the dependency injection container. We can then build a callable and</span><br><span class="line">                    // execute the pipe function giving in the parameters that are required.</span><br><span class="line">                    $pipe = $this-&gt;getContainer()-&gt;make($name);</span><br><span class="line"></span><br><span class="line">                    $parameters = array_merge([$passable, $stack], $parameters);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // If the pipe is already an object we&#x27;ll just make a callable and pass it to</span><br><span class="line">                    // the pipe as-is. There is no need to do any extra parsing and formatting</span><br><span class="line">                    // since the object we&#x27;re given was already a fully instantiated object.</span><br><span class="line">                    $parameters = [$passable, $stack];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $carry = method_exists($pipe, $this-&gt;method)</span><br><span class="line">                                ? $pipe-&gt;&#123;$this-&gt;method&#125;(...$parameters)</span><br><span class="line">                                : $pipe(...$parameters);</span><br><span class="line"></span><br><span class="line">                return $this-&gt;handleCarry($carry);</span><br><span class="line">            &#125; catch (Throwable $e) &#123;</span><br><span class="line">                return $this-&gt;handleException($passable, $e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="array-reduce"><a href="#array-reduce" class="headerlink" title="array_reduce"></a>array_reduce</h3><p>如果猜的没错，Laravel 应该就是使用 <code>array_reduce</code> 来实现中间件的。</p>
<p>查了一下 PHP 的官方文档，它对 <code>array_reduce</code> 的描述是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_reduce — 用回调函数迭代地将数组简化为单一的值</span><br></pre></td></tr></table></figure>

<p>嗯……不愧是官方文档，说了跟没讲一样。</p>
<p>还是通过实战来了解一下什么是 <code>array_reduce</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$params = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;];</span><br><span class="line">$result = array_reduce($params, function ($carry, $item) &#123;</span><br><span class="line"></span><br><span class="line">    var_dump(&#x27;carry=&#x27; . $carry);</span><br><span class="line">    var_dump(&#x27;item=&#x27; . $item);</span><br><span class="line"></span><br><span class="line">    return $carry . $item;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var_dump($result);</span><br></pre></td></tr></table></figure>

<p>声明一个数组 $params 且包含三个字符串，</p>
<p>然后通过 array_reduce 传入数组参数，同时还有一个闭包，</p>
<p>闭包接收两个参数 $carry, $item，然后试着打印这两个参数以及最终结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">string(6) &quot;carry=&quot;</span><br><span class="line">string(6) &quot;item=a&quot;</span><br><span class="line">string(7) &quot;carry=a&quot;</span><br><span class="line">string(6) &quot;item=b&quot;</span><br><span class="line">string(8) &quot;carry=ab&quot;</span><br><span class="line">string(6) &quot;item=c&quot;</span><br><span class="line">string(3) &quot;abc&quot;</span><br></pre></td></tr></table></figure>

<p>也就是说，一开始 $carry 的值是空的（Null），然后随着循环，</p>
<p>$carry 会逐渐合并数组的每一个元素。</p>
<p><code>array_reduce</code> 可以说是如下代码构成的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$params = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;];</span><br><span class="line">$result = null;</span><br><span class="line"></span><br><span class="line">foreach ($params as $param) &#123;</span><br><span class="line">    $result .= $param;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var_dump($result);</span><br></pre></td></tr></table></figure>

<p>循环遍历数组的每一个元素，然后保持一个不变的值。</p>
<p>与官方文档的描述对应起来了！<strong>将数组简化为一个单一的值。</strong></p>
<p>也就是说通过 <code>array_reduce</code> 最终会返回一个值作为处理的结果。</p>
<p><code>array_reduce</code> 可以接收第三个参数，即初始值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$params = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;];</span><br><span class="line">$result = array_reduce($params, function ($carry, $item) &#123;</span><br><span class="line">    return $carry . $item;</span><br><span class="line">&#125;, &#x27;init&#x27;);</span><br><span class="line"></span><br><span class="line">var_dump($result);</span><br></pre></td></tr></table></figure>

<p>最终会输出：<code>initabc</code></p>
<p>如果不设置第三个参数，那么初始值就会默认为 Null。</p>
<p>最开始，我以为会是返回 true 或者 false 来判定中间件的执行结果，</p>
<p>但是 Laravel 的设计却令人惊叹！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Get a Closure that represents a slice of the application onion.</span><br><span class="line"> *</span><br><span class="line"> * @return \Closure</span><br><span class="line"> */</span><br><span class="line">protected function carry()</span><br><span class="line">&#123;</span><br><span class="line">    return function ($stack, $pipe) &#123;</span><br><span class="line">        return function ($passable) use ($stack, $pipe) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                if (is_callable($pipe)) &#123;</span><br><span class="line">                    // If the pipe is a callable, then we will call it directly, but otherwise we</span><br><span class="line">                    // will resolve the pipes out of the dependency container and call it with</span><br><span class="line">                    // the appropriate method and arguments, returning the results back out.</span><br><span class="line">                    return $pipe($passable, $stack);</span><br><span class="line">                &#125; elseif (! is_object($pipe)) &#123;</span><br><span class="line">                    [$name, $parameters] = $this-&gt;parsePipeString($pipe);</span><br><span class="line"></span><br><span class="line">                    // If the pipe is a string we will parse the string and resolve the class out</span><br><span class="line">                    // of the dependency injection container. We can then build a callable and</span><br><span class="line">                    // execute the pipe function giving in the parameters that are required.</span><br><span class="line">                    $pipe = $this-&gt;getContainer()-&gt;make($name);</span><br><span class="line"></span><br><span class="line">                    $parameters = array_merge([$passable, $stack], $parameters);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // If the pipe is already an object we&#x27;ll just make a callable and pass it to</span><br><span class="line">                    // the pipe as-is. There is no need to do any extra parsing and formatting</span><br><span class="line">                    // since the object we&#x27;re given was already a fully instantiated object.</span><br><span class="line">                    $parameters = [$passable, $stack];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $carry = method_exists($pipe, $this-&gt;method)</span><br><span class="line">                                ? $pipe-&gt;&#123;$this-&gt;method&#125;(...$parameters)</span><br><span class="line">                                : $pipe(...$parameters);</span><br><span class="line"></span><br><span class="line">                return $this-&gt;handleCarry($carry);</span><br><span class="line">            &#125; catch (Throwable $e) &#123;</span><br><span class="line">                return $this-&gt;handleException($passable, $e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码十分生涩难懂，简直如同“天书”，</p>
<p>因此我自己尝试实现相同的逻辑并且让代码变成“说人话”。</p>
<h3 id="对暗号游戏"><a href="#对暗号游戏" class="headerlink" title="对暗号游戏"></a>对暗号游戏</h3><p>接下来我开始参考着 Laravel 中间件的代码实现一个“对暗号”的“游戏”，</p>
<p>比如在一个军营里，一共有 A、B、C 三个巡逻队，</p>
<p>为了避免整个暗号泄露出去，规定每一个巡逻队都只持有暗号的其中一句，</p>
<p>今晚的暗号是：“上山打老虎”，</p>
<p>那么三个巡逻队分别得到的暗号是：</p>
<p>A：上山</p>
<p>B：打</p>
<p>C：老虎</p>
<p>而你半夜出去嘘嘘，刚好被巡逻队给碰上了……</p>
<p>于是，你必须说出你的口令，否则就会被当做奸细就地正法……</p>
<p>三只巡逻队可以抽象成“巡逻队”概念，即定义一个 Middleware 作为父类，</p>
<p>他们都有核对口号的方法 handle，以及自己的密令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">abstract class Middleware</span><br><span class="line">&#123;</span><br><span class="line">    public $keyword;</span><br><span class="line"></span><br><span class="line">    public function handle($value, Closure $closure)</span><br><span class="line">    &#123;</span><br><span class="line">        var_dump(&#x27;暗号：&#x27; . $this-&gt;keyword);</span><br><span class="line"></span><br><span class="line">        // 包含指定关键词的口令视为核对成功</span><br><span class="line">        if (strstr($value, $this-&gt;keyword) != false) &#123;</span><br><span class="line">            return $closure($value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &#x27;口令核对失败&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着创建三个巡逻队，继承基类并且拥有独立的口令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Middleware_A extends Middleware</span><br><span class="line">&#123;</span><br><span class="line">    public $keyword = &#x27;上山&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Middleware_B extends Middleware</span><br><span class="line">&#123;</span><br><span class="line">    public $keyword = &#x27;打&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Middleware_C extends Middleware</span><br><span class="line">&#123;</span><br><span class="line">    public $keyword = &#x27;老虎&#x27;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来实现具体的逻辑，声明一个包含 N 只巡逻队的数组（可以是 0-3 个）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function middlewares()</span><br><span class="line">&#123;</span><br><span class="line">    $params = [&#x27;Middleware_A&#x27;, &#x27;Middleware_B&#x27;, &#x27;Middleware_C&#x27;];</span><br><span class="line">    $params = array_reverse($params);</span><br><span class="line"></span><br><span class="line">    return $params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里增加了一个 <code>array_reverse</code> 将数组反转的方法，下文会解释。</p>
<p>然后实现核对密令的逻辑，比如你遇到巡逻队 A，那就核对巡逻队 A 的密令，</p>
<p>如果同时遇到两只巡逻队，A+B 或者 A+C 或者 B+C，那就应该核对两个巡逻队的密令，</p>
<p>如果你非常不幸的同时遇到三只巡逻队，那就要核对 ABC 的密令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function carry()</span><br><span class="line">&#123;</span><br><span class="line">    return function ($stack, $pipe) &#123;</span><br><span class="line">        return function ($passable) use ($stack, $pipe) &#123;</span><br><span class="line"></span><br><span class="line">            if ($pipe instanceof Closure) &#123;</span><br><span class="line">                return $pipe($passable, $stack);</span><br><span class="line">            &#125; elseif (!is_object($pipe)) &#123;</span><br><span class="line">                $pipe = new $pipe;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return $pipe-&gt;handle($passable, $stack);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function init()</span><br><span class="line">&#123;</span><br><span class="line">    return function ($destination) &#123;</span><br><span class="line"></span><br><span class="line">        var_dump($destination);</span><br><span class="line"></span><br><span class="line">        return &#x27;ok&#x27;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$response = array_reduce(middlewares(), carry(), init());</span><br><span class="line"></span><br><span class="line">var_dump($response(&#x27;小鸡炖蘑菇&#x27;));</span><br><span class="line">var_dump($response(&#x27;上山打野鸡&#x27;));</span><br><span class="line">var_dump($response(&#x27;上山打老虎&#x27;));</span><br></pre></td></tr></table></figure>

<p>上面的代码虽然很短，但是要理解起来非常不易。</p>
<p><code>array_reduce</code> 可以接收三个参数：</p>
<p>第一个参数是数组，即要遍历的数组；</p>
<p>第二个参数是一个方法&#x2F;闭包（匿名函数），即执行遍历的逻辑；</p>
<p>第三个参数是初始值。</p>
<p>初始值是最终想要实现的结果，当满足所有条件后，就会返回初始值函数里的代码。</p>
<p>而 <code>middlewares</code> 是最开始定义巡逻队的地方，很不幸你同时遇到三只巡逻队：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function middlewares()</span><br><span class="line">&#123;</span><br><span class="line">    $params = [&#x27;Middleware_A&#x27;, &#x27;Middleware_B&#x27;, &#x27;Middleware_C&#x27;];</span><br><span class="line">    $params = array_reverse($params);</span><br><span class="line"></span><br><span class="line">    return $params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>array_reverse</code> 这里的反转数组与接下来的堆栈调用有关，</p>
<p>栈结构是先进后出，会导致乱序，我们希望的结果是按照 A、B、C 的顺序执行。</p>
<p><code>init</code> 方法定义了最终希望输出的值，如果满足所有条件的话，就返回这个值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function init()</span><br><span class="line">&#123;</span><br><span class="line">    return function ($destination) &#123;</span><br><span class="line"></span><br><span class="line">        var_dump($destination);</span><br><span class="line"></span><br><span class="line">        return &#x27;ok&#x27;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>carry</code> 是整个逻辑最关键的部分：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function carry()</span><br><span class="line">&#123;</span><br><span class="line">    return function ($stack, $pipe) &#123;</span><br><span class="line">        return function ($passable) use ($stack, $pipe) &#123;</span><br><span class="line"></span><br><span class="line">            if ($pipe instanceof Closure) &#123;</span><br><span class="line">                return $pipe($passable, $stack);</span><br><span class="line">            &#125; elseif (!is_object($pipe)) &#123;</span><br><span class="line">                $pipe = new $pipe;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return $pipe-&gt;handle($passable, $stack);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法涉及了闭包的递归调用，<strong>最终的返回结果依然是一个闭包。</strong></p>
<p>carry 方法传入两个参数 $stack, </p>
<p>$stack 即遍历过程中持续引用的值，而 $pipe 则是当前元素。</p>
<p>回忆一下上面的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$params = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;];</span><br><span class="line">$result = array_reduce($params, function ($carry, $item) &#123;</span><br><span class="line">    return $carry . $item;</span><br><span class="line">&#125;, &#x27;init&#x27;);</span><br><span class="line"></span><br><span class="line">var_dump($result);</span><br></pre></td></tr></table></figure>

<p>应该不难理解，这里就是循环遍历一个数组，依次取值进行计算，最终返回一个结果而已。</p>
<p>接下来分析代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">return function ($stack, $pipe) &#123;</span><br><span class="line">    return function ($passable) use ($stack, $pipe) &#123;</span><br><span class="line"></span><br><span class="line">        if ($pipe instanceof Closure) &#123;</span><br><span class="line">            return $pipe($passable, $stack);</span><br><span class="line">        &#125; elseif (!is_object($pipe)) &#123;</span><br><span class="line">            $pipe = new $pipe;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $pipe-&gt;handle($passable, $stack);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>carry 返回一个闭包，同时它内层的代码也是返回一个闭包，并且接收一个 $passable 作为参数。</p>
<blockquote>
<p>$passable 的作用就是递归函数中不断传给下一次调用的值</p>
</blockquote>
<p>在最内层，是一个条件判断语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if ($pipe instanceof Closure) &#123;</span><br><span class="line">    return $pipe($passable, $stack);</span><br><span class="line">&#125; elseif (!is_object($pipe)) &#123;</span><br><span class="line">    $pipe = new $pipe;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return $pipe-&gt;handle($passable, $stack);</span><br></pre></td></tr></table></figure>

<p>如果传来的值不是 Closure（闭包类型），则判断它是否是一个对象，</p>
<p>如果不是对象则根据这个元素的名字实例化出对象来：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (!is_object($pipe)) &#123;</span><br><span class="line">    $pipe = new $pipe;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终调用实例化对象的 handle 方法，并且把 $passable 和 持续保留的那个值 $stack 传给 handle。</p>
<p>再看一次执行的逻辑，并且模拟每一次执行的结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">return function ($stack, $pipe) &#123;</span><br><span class="line">    return function ($passable) use ($stack, $pipe) &#123;</span><br><span class="line"></span><br><span class="line">        if ($pipe instanceof Closure) &#123;</span><br><span class="line">            return $pipe($passable, $stack);</span><br><span class="line">        &#125; elseif (!is_object($pipe)) &#123;</span><br><span class="line">            $pipe = new $pipe;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $pipe-&gt;handle($passable, $stack);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>假设调用方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// array_reduce 返回的是一个闭包，可以当做函数调用</span><br><span class="line">$response = array_reduce(middlewares(), carry(), init());</span><br><span class="line"></span><br><span class="line">// 传入一个用来验证的口令</span><br><span class="line">$result = $response(&#x27;上山打野鸡&#x27;);</span><br><span class="line"></span><br><span class="line">// 打印出验证结果</span><br><span class="line">var_dump($result);</span><br></pre></td></tr></table></figure>

<p>第一次遍历：</p>
<p>通过 init 方法赋值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">// 第一步：$stack 赋值，init 方法也是一个闭包，接收一个 $destination 参数</span><br><span class="line">// $stack 的初始值即 init 方法返回的闭包，所以是：</span><br><span class="line"></span><br><span class="line">$stack = function ($destination) &#123;</span><br><span class="line">     var_dump($destination);</span><br><span class="line">     </span><br><span class="line">     return &#x27;ok&#x27;;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line">// 接着，取出数组的第一个元素</span><br><span class="line">$pipe = &#x27;Middleware_A&#x27;;</span><br><span class="line"></span><br><span class="line">// 第二步，进入闭包：function ($passable) use ($stack, $pipe)</span><br><span class="line">// 这里的 $passable 就是上面调用时传入的值：“上山打野鸡”</span><br><span class="line">// 执行判断语句</span><br><span class="line"></span><br><span class="line">if ($pipe instanceof Closure) &#123;</span><br><span class="line">    return $pipe($passable, $stack);</span><br><span class="line">&#125; elseif (!is_object($pipe)) &#123;</span><br><span class="line">    $pipe = new $pipe;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 很明显 $pipe 此时只是一个字符串，因此不满足 $pipe instanceof Closure</span><br><span class="line">// 于是进入 else 条件 !is_object($pipe) 它并不是一个对象，因此满足此条件</span><br><span class="line">// 所以将 $pipe = new $pipe; 实例化成对象</span><br><span class="line">// 此处的代码即：$pipe = new Middleware_A();</span><br><span class="line">// 实例化出巡逻队A的对象，然后调用他的 handle 方法并返回</span><br><span class="line"></span><br><span class="line">return $pipe-&gt;handle($passable, $stack);</span><br><span class="line"></span><br><span class="line">// Middleware_A 继承了父类 Middleware，因此 handle 为：</span><br><span class="line"></span><br><span class="line">public function handle($value, Closure $closure)</span><br><span class="line">&#123;</span><br><span class="line">    var_dump(&#x27;暗号：&#x27; . $this-&gt;keyword);</span><br><span class="line"></span><br><span class="line">    // 包含指定关键词的口令视为核对成功</span><br><span class="line">    if (strstr($value, $this-&gt;keyword) != false) &#123;</span><br><span class="line">        return $closure($value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#x27;口令核对失败&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 此时 value 的值为：上山打野鸡，巡逻队A的暗号是：上山</span><br><span class="line">// 因此巡逻队A验证成功，将这个值传给闭包然后返回</span><br><span class="line"></span><br><span class="line">return $closure($value);</span><br><span class="line"></span><br><span class="line">// 接收到参数的 $closure 就是 $stack，也就是我们最开始定义的 init 方法</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二次遍历：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// 此时已经不会经过 init 初始化了，</span><br><span class="line">// $stack的值是第一步返回的 return $pipe-&gt;handle($passable, $stack);</span><br><span class="line">// 也就是说init方法</span><br><span class="line"></span><br><span class="line">// 第二次遍历$pipe就会取第二个巡逻队：Middleware_B</span><br><span class="line">// 继续进入 function ($passable) use ($stack, $pipe) 执行判断语句</span><br><span class="line"></span><br><span class="line">if ($pipe instanceof Closure) &#123;</span><br><span class="line">    return $pipe($passable, $stack);</span><br><span class="line">&#125; elseif (!is_object($pipe)) &#123;</span><br><span class="line">    $pipe = new $pipe;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 同样Middleware_B只是一个字符串，因此会被实例化成类</span><br><span class="line">// 然后与第一步一样，进行比对暗号，Middleware_B的暗号是：打</span><br><span class="line">// 因此：上山打野鸡包含了这个字符，就符合巡逻队B的暗号</span><br><span class="line">// 又经过父类的方法：</span><br><span class="line"></span><br><span class="line">public function handle($value, Closure $closure)</span><br><span class="line">&#123;</span><br><span class="line">    var_dump(&#x27;暗号：&#x27; . $this-&gt;keyword);</span><br><span class="line"></span><br><span class="line">    // 包含指定关键词的口令视为核对成功</span><br><span class="line">    if (strstr($value, $this-&gt;keyword) != false) &#123;</span><br><span class="line">        return $closure($value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#x27;口令核对失败&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// init 方法继续被传递给下一个执行的对象</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第三步，也就是最后的一个巡逻队了，这里产生了一个分歧点，即最后一个暗号不符合要求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// 第三次遍历$pipe就会取第三个巡逻队：Middleware_C</span><br><span class="line">// 继续进入 function ($passable) use ($stack, $pipe) 执行判断语句</span><br><span class="line"></span><br><span class="line">if ($pipe instanceof Closure) &#123;</span><br><span class="line">    return $pipe($passable, $stack);</span><br><span class="line">&#125; elseif (!is_object($pipe)) &#123;</span><br><span class="line">    $pipe = new $pipe;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 一样是实例化的过程，然后分歧点出现了</span><br><span class="line">// 第三个巡逻队的暗号是：老虎，而此时给出的却是：上山打野鸡</span><br><span class="line">// 不包括“老虎”两个字</span><br><span class="line"></span><br><span class="line">public function handle($value, Closure $closure)</span><br><span class="line">&#123;</span><br><span class="line">    var_dump(&#x27;暗号：&#x27; . $this-&gt;keyword);</span><br><span class="line"></span><br><span class="line">    // 包含指定关键词的口令视为核对成功</span><br><span class="line">    if (strstr($value, $this-&gt;keyword) != false) &#123;</span><br><span class="line">        return $closure($value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#x27;口令核对失败&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 不符合结果就直接返回了一个字符串“口令核对失败”</span><br><span class="line">// 这个返回的值会被当做$stack的值</span><br><span class="line">// 最后就跟递归函数一样层层返回，将“口令核对失败”作为array_reduce将数组简化的唯一值</span><br><span class="line"></span><br><span class="line">// 也就是说，$response(&#x27;上山打野鸡&#x27;) 最后返回的是“口令核对失败”</span><br><span class="line"></span><br><span class="line">// array_reduce 返回的是一个闭包，可以当做函数调用</span><br><span class="line">$response = array_reduce(middlewares(), carry(), init());</span><br><span class="line"></span><br><span class="line">// 传入一个用来验证的口令</span><br><span class="line">$result = $response(&#x27;上山打野鸡&#x27;);</span><br><span class="line"></span><br><span class="line">// 打印出验证结果</span><br><span class="line">var_dump($result);</span><br></pre></td></tr></table></figure>

<p>如果是传入正确的口令：上山打老虎呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 巡逻队C核对口令正确，就会继续把参数传给闭包</span><br><span class="line">public function handle($value, Closure $closure)</span><br><span class="line">&#123;</span><br><span class="line">    var_dump(&#x27;暗号：&#x27; . $this-&gt;keyword);</span><br><span class="line"></span><br><span class="line">    // 包含指定关键词的口令视为核对成功</span><br><span class="line">    if (strstr($value, $this-&gt;keyword) != false) &#123;</span><br><span class="line">        return $closure($value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#x27;口令核对失败&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 此时三个巡逻队已经遍历完了，还记得一直传下来的$stack的值是什么吗？</span><br><span class="line">// 答案是：init</span><br><span class="line">// 你可以重新返回去查看第一步到第三步，只要是验证口令成功的时候，</span><br><span class="line">// init 方法都会被当做下一个闭包传递下去，init 闭包即 $stack 的值</span><br><span class="line">// 所以最终返回的 $stack 即 init 方法</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意！上面的 array_reduce 执行完毕后并不是真的执行了代码，而是返回一个层层嵌套的递归函数（闭包），只有在调用的时候才会一层一层的执行，因而最先调用的中间件反而会变成最后执行（栈结构先进后出），所以我们才会在最开始反转数组，以保证执行顺序。</p>
</blockquote>
<p>至此，Laravel 中间件验证路由请求的原理也就搞清楚了。</p>
<p>捋顺之后只剩下久久的深思，一段简单的代码却蕴藏着如此精深的奥妙。</p>
<p>可是……写完了如此长篇的文章，我的框架的中间件却还没有开始着手……</p>
<h2 id="为框架添加中间件"><a href="#为框架添加中间件" class="headerlink" title="为框架添加中间件"></a>为框架添加中间件</h2><h3 id="中间件原理"><a href="#中间件原理" class="headerlink" title="中间件原理"></a>中间件原理</h3><p>中间件其实跟路由的原理类似，即创建一个专门保存命名和映射关系的配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 键值对数组的键即中间件名称，值即对应的中间件</span><br><span class="line">&#x27;auth&#x27; =&gt; &#x27;App\\Middleware\\AuthMiddleware&#x27;</span><br></pre></td></tr></table></figure>

<p>只需要用一个简单的名称字符串即可映射到对应的中间件类。</p>
<p>由于一个路由可以有很多个中间件，所以路由配置里需要添加一个数组用来存储中间件的名称。</p>
<h3 id="优化路由模块"><a href="#优化路由模块" class="headerlink" title="优化路由模块"></a>优化路由模块</h3><p>在之前的设计中，Router 的 $routes 设计为静态变量，</p>
<p>其实只要修改 http_server.php 修改引入方式即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require &#x27;./vendor/autoload.php&#x27;;</span><br><span class="line">require_once &#x27;./app/route/web.php&#x27;;</span><br><span class="line"></span><br><span class="line">$http = new Swoole\Http\Server(&#x27;0.0.0.0&#x27;, 9527);</span><br><span class="line"></span><br><span class="line">$http-&gt;on(&#x27;request&#x27;, function ($request, $response) use ($router) &#123;</span><br><span class="line"></span><br><span class="line">    var_dump(&#x27;请求URI：&#x27; . $request-&gt;server[&#x27;request_uri&#x27;]);</span><br><span class="line"></span><br><span class="line">    $router-&gt;handle($request, $response);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$http-&gt;start();</span><br></pre></td></tr></table></figure>

<p>而路由配置文件 web.php 只要返回 $router 即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$router = new \FireRabbitEngine\Module\Route\Router();</span><br><span class="line"></span><br><span class="line">$router-&gt;setConfig([</span><br><span class="line"></span><br><span class="line">    &#x27;namespace&#x27; =&gt; &#x27;App\\Controller\\Home\\&#x27;,</span><br><span class="line"></span><br><span class="line">])-&gt;group(function () use ($router) &#123;</span><br><span class="line"></span><br><span class="line">    $router-&gt;get(&#x27;/user&#x27;, &#x27;IndexController@index&#x27;)-&gt;name(&#x27;index&#x27;);</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">return $router;</span><br></pre></td></tr></table></figure>

<p>这样 Router 的 $routes 就不再需要设置为静态变量了。</p>
<h3 id="路由添加中间件"><a href="#路由添加中间件" class="headerlink" title="路由添加中间件"></a>路由添加中间件</h3><p>在路由配置的时候，期望效果是可以通过如下两种方式配置中间件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$router = new \FireRabbitEngine\Module\Route\Router();</span><br><span class="line"></span><br><span class="line">$router-&gt;setConfig([</span><br><span class="line"></span><br><span class="line">    &#x27;namespace&#x27; =&gt; &#x27;App\\Controller\\Home\\&#x27;,</span><br><span class="line">    &#x27;middleware&#x27; =&gt; [&#x27;auth&#x27;]</span><br><span class="line"></span><br><span class="line">])-&gt;group(function () use ($router) &#123;</span><br><span class="line"></span><br><span class="line">    $router-&gt;get(&#x27;/user&#x27;, &#x27;IndexController@index&#x27;)-&gt;name(&#x27;index&#x27;)-&gt;middleware([&#x27;auth&#x27;]);</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">return $router;</span><br></pre></td></tr></table></figure>

<p>第一种是在分组的时候，配置全组共用的中间件，</p>
<p>第二种是在单个路由配置的时候，可以自定义该路由的中间件，</p>
<p>如果使用第二种方法，并且该路由在一个分组里，该路由不仅有分组的中间件，还有自己单独添加的中间件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$router = new \FireRabbitEngine\Module\Route\Router();</span><br><span class="line"></span><br><span class="line">$router-&gt;setConfig([</span><br><span class="line"></span><br><span class="line">    &#x27;namespace&#x27; =&gt; &#x27;App\\Controller\\Home\\&#x27;,</span><br><span class="line">    &#x27;middleware&#x27; =&gt; [&#x27;auth&#x27;]</span><br><span class="line"></span><br><span class="line">])-&gt;group(function () use ($router) &#123;</span><br><span class="line"></span><br><span class="line">    // 这个路由的中间件为：[auth, other]</span><br><span class="line">    $router-&gt;get(&#x27;/user&#x27;, &#x27;IndexController@index&#x27;)-&gt;middleware([&#x27;other&#x27;]);</span><br><span class="line"></span><br><span class="line">    // 这个路由的中间件为：[auth]</span><br><span class="line">    $router-&gt;get(&#x27;/admin&#x27;, &#x27;IndexController@index&#x27;);</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">return $router;</span><br></pre></td></tr></table></figure>

<p>上面的 &#x2F;user 路由额外添加了一个中间件 other，而 &#x2F;admin 路由不会受到影响。</p>
<p>中间件的合并顺序为：分组&gt;自定义</p>
<p>即优先执行分组设置的全局中间件，然后再执行自定义中间件。</p>
<p>middleware 方法必须放在 get&#x2F;post&#x2F;any 方法之后。</p>
<p>修改 name 方法，让该方法也返回 $this，这样就可以链式调用了。</p>
<p>然后为 Router 添加 middleware 方法，该方法接收一个数组参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// 新增属性(全局中间件)</span><br><span class="line">protected $middlewares = [];</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* 路由添加中间件</span><br><span class="line">*</span><br><span class="line">* @param array $middlewares</span><br><span class="line">* @return Router</span><br><span class="line">*/</span><br><span class="line">public function middleware(array $middlewares)</span><br><span class="line">&#123;</span><br><span class="line">    if ($this-&gt;lastHandleRouteIndex === null) &#123;</span><br><span class="line">        return $this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 合并中间件，优先级为：分组&gt;单个路由自定义配置</span><br><span class="line">    $middlewares = array_merge($this-&gt;middlewares, $middlewares);</span><br><span class="line">    // 去除重复中间件</span><br><span class="line">    $middlewares = array_unique($middlewares);</span><br><span class="line">    // 找到最后一个添加的路由</span><br><span class="line">    $route = $this-&gt;routes[$this-&gt;lastHandleRouteIndex];</span><br><span class="line">    $route-&gt;middleware = $middlewares;</span><br><span class="line"></span><br><span class="line">    $this-&gt;routes[$this-&gt;lastHandleRouteIndex] = $route;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是分组的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 设置参数</span><br><span class="line">* @param $key</span><br><span class="line">* @param $value</span><br><span class="line">*/</span><br><span class="line">protected function createConfig($key, $value)</span><br><span class="line">&#123;</span><br><span class="line">    switch ($key) &#123;</span><br><span class="line">        case &#x27;namespace&#x27;:</span><br><span class="line">            $this-&gt;namespace = $value;</span><br><span class="line">            break;</span><br><span class="line">        case &#x27;middleware&#x27;:</span><br><span class="line">            $this-&gt;middlewares = $value;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分组配置时将中间件加入全局的中间件数组。</p>
<p>在调用结束的时候，应该把这个数组清空：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 路由分组</span><br><span class="line">* @param $func</span><br><span class="line">*/</span><br><span class="line">public function group($func)</span><br><span class="line">&#123;</span><br><span class="line">    $func();</span><br><span class="line"></span><br><span class="line">    // 执行完成后将参数初始化</span><br><span class="line">    $this-&gt;namespace = &#x27;&#x27;;</span><br><span class="line">    $this-&gt;middlewares = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给路由增加中间件的功能就完成了。</p>
<p>现在 RouteParams 路由配置对象里已经可以取到 middleware 属性的值了。</p>
<h3 id="封装请求与响应"><a href="#封装请求与响应" class="headerlink" title="封装请求与响应"></a>封装请求与响应</h3><p>框架的请求和响应是 swoole 的对象，内置的方法无法满足框架的需求，</p>
<p>因此需要将请求和响应进行封装，在框架的 module 目录新建文件夹 Http，</p>
<p>Http 模块用于实现 Http 请求相关的处理类，新建两个类：Request 和 Response 用于封装请求和响应：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"># Request.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace FireRabbitEngine\Module\Http;</span><br><span class="line"></span><br><span class="line">use FireRabbitEngine\Module\Route\RouteParams;</span><br><span class="line"></span><br><span class="line">class Request</span><br><span class="line">&#123;</span><br><span class="line">    protected $request, $route;</span><br><span class="line"></span><br><span class="line">    public function __construct($request, $route)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;request = $request;</span><br><span class="line">        $this-&gt;route = $route;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getRequest()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取路由</span><br><span class="line">     * @return mixed</span><br><span class="line">     */</span><br><span class="line">    public function getRoute(): RouteParams</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;route;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 判断该请求是否ajax</span><br><span class="line">     * @return bool</span><br><span class="line">     */</span><br><span class="line">    public function isAjax()</span><br><span class="line">    &#123;</span><br><span class="line">        return &#x27;XMLHttpRequest&#x27; == $this-&gt;request-&gt;header[&#x27;x-requested-with&#x27;];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取get参数</span><br><span class="line">     * @param null $key</span><br><span class="line">     * @param null $default</span><br><span class="line">     * @return mixed</span><br><span class="line">     */</span><br><span class="line">    public function getQueryParams($key = null, $default = null)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($key == null) &#123;</span><br><span class="line">            return $this-&gt;request-&gt;get;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return isset($this-&gt;request-&gt;get[$key]) ? $this-&gt;request-&gt;get[$key] : $default;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取post参数</span><br><span class="line">     * @param null $key</span><br><span class="line">     * @param null $default</span><br><span class="line">     * @return mixed</span><br><span class="line">     */</span><br><span class="line">    public function getPostParams($key = null, $default = null)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($key == null) &#123;</span><br><span class="line">            return $this-&gt;request-&gt;post;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return isset($this-&gt;request-&gt;post[$key]) ? $this-&gt;request-&gt;post[$key] : $default;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取请求方法</span><br><span class="line">     * @return string</span><br><span class="line">     */</span><br><span class="line">    public function getRequestMethod()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;request-&gt;server[&#x27;request_method&#x27;];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取请求IP地址</span><br><span class="line">     * @return string | null</span><br><span class="line">     */</span><br><span class="line">    public function getRequestIP()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;request-&gt;header[&#x27;x-real-ip&#x27;] ?? null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取请求头</span><br><span class="line">     * @param $key</span><br><span class="line">     * @return string | null</span><br><span class="line">     */</span><br><span class="line">    public function getHeaders($key = null)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($key == null) &#123;</span><br><span class="line">            return $this-&gt;request-&gt;header;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $this-&gt;request-&gt;header[$key] ?? null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取cookie</span><br><span class="line">     * @param $key</span><br><span class="line">     * @return string | null</span><br><span class="line">     */</span><br><span class="line">    public function getCookies($key = null)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($key == null) &#123;</span><br><span class="line">            return $this-&gt;request-&gt;cookie;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $this-&gt;request-&gt;cookie[$key] ?? null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取请求URI</span><br><span class="line">     * @return mixed</span><br><span class="line">     */</span><br><span class="line">    public function getRequestURI()</span><br><span class="line">    &#123;</span><br><span class="line">        return rtrim($this-&gt;request-&gt;server[&#x27;request_uri&#x27;], &#x27;/&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Request 请求类实现了一些简单方法的封装，后续如有需求还可以继续扩展。</p>
<p>接下来创建 Response 响应类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * Created by PhpStorm</span><br><span class="line"> * Author：FireRabbit</span><br><span class="line"> * Date：2/12/21</span><br><span class="line"> * Time：11:31 AM</span><br><span class="line"> **/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">namespace FireRabbitEngine\Module\Http;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Response</span><br><span class="line">&#123;</span><br><span class="line">    protected $response;</span><br><span class="line"></span><br><span class="line">    public function __construct($response)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;response = $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getResponse()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function showMessage($message)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;response-&gt;header(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;);</span><br><span class="line">        $this-&gt;response-&gt;end($message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类实现了一个简单的输出消息的方法，后续将会增加输出 view 和 API 类型的响应。</p>
<p>现在 Request 和 Response 都有了，但是每次都要分别取这两个对象不太方便，</p>
<p>于是我又定义了一个 Kernel（Http 请求核心类）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace FireRabbitEngine\Module\Http;</span><br><span class="line"></span><br><span class="line">class Kernel</span><br><span class="line">&#123;</span><br><span class="line">    protected $request, $response;</span><br><span class="line"></span><br><span class="line">    public function __construct(Request $request, Response $response)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;request = $request;</span><br><span class="line">        $this-&gt;response = $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getRequest()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;request-&gt;getRequest();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getResponse()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;response-&gt;getResponse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getHttpRequest()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getHttpResponse()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类可以取到 swoole 的请求和响应，也可以取到框架自定义的请求和响应。</p>
<p>这样就把请求和响应封装成一个 Http 核心类了。</p>
<h3 id="中间件类"><a href="#中间件类" class="headerlink" title="中间件类"></a>中间件类</h3><p>Laravel 的中间件不需要继承任何类，完全由用户自定义，</p>
<p>为了统一规范，我定义了一个中间件的父类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace FireRabbitEngine\Module\Http;</span><br><span class="line"></span><br><span class="line">use Closure;</span><br><span class="line"></span><br><span class="line">abstract class Middleware</span><br><span class="line">&#123;</span><br><span class="line">    abstract public function handle(Kernel $kernel, Closure $next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里类只有一个抽象方法 handle，所有的中间件继承这个类实现统一的标准。</p>
<p>handle 第一个参数即上文封装的 kernel，在中间件里通过 kernel 来获取参数和返回响应。</p>
<p>再在博客项目的路径下，新建 app&#x2F;middleware 用来存放中间件 TestMiddlewareA 和 TestMiddlewareB：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Middleware;</span><br><span class="line"></span><br><span class="line">use Closure;</span><br><span class="line">use FireRabbitEngine\Module\Http\Kernel;</span><br><span class="line">use FireRabbitEngine\Module\Http\Middleware;</span><br><span class="line"></span><br><span class="line">class TestMiddlewareA extends Middleware</span><br><span class="line">&#123;</span><br><span class="line">    public function handle(Kernel $kernel, Closure $next)</span><br><span class="line">    &#123;</span><br><span class="line">        $request = $kernel-&gt;getHttpRequest();</span><br><span class="line"></span><br><span class="line">        if ($request-&gt;getQueryParams(&#x27;a&#x27;) == 1) &#123;</span><br><span class="line">            $kernel-&gt;getHttpResponse()-&gt;showMessage(&#x27;aa&#x27;);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $next($kernel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TestMiddlewareB：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Middleware;</span><br><span class="line"></span><br><span class="line">use Closure;</span><br><span class="line">use FireRabbitEngine\Module\Http\Kernel;</span><br><span class="line">use FireRabbitEngine\Module\Http\Middleware;</span><br><span class="line"></span><br><span class="line">class TestMiddlewareB extends Middleware</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    public function handle(Kernel $kernel, Closure $next)</span><br><span class="line">    &#123;</span><br><span class="line">        $request = $kernel-&gt;getHttpRequest();</span><br><span class="line"></span><br><span class="line">        if ($request-&gt;getQueryParams(&#x27;b&#x27;) == 1) &#123;</span><br><span class="line">            $kernel-&gt;getHttpResponse()-&gt;showMessage(&#x27;bb&#x27;);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $next($kernel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个中间件的逻辑非常简单，就是通过 get 参数来判断是否通过请求，</p>
<p>这样在测试的时候就很方便了，只要在路径上面修改参数即可看到中间件的效果。</p>
<blockquote>
<p>中间件实际上可以不需要 return null，为了美观后面会对此处的代码进行优化。</p>
</blockquote>
<h3 id="中间件逻辑"><a href="#中间件逻辑" class="headerlink" title="中间件逻辑"></a>中间件逻辑</h3><p>前文通过 array_reduce 来演示 Laravel 中间件的处理逻辑，</p>
<p>现在就要把这个逻辑在框架中进行实现，在 Http 文件夹下新建一个 PipeLine 类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace FireRabbitEngine\Module\Http;</span><br><span class="line"></span><br><span class="line">use Closure;</span><br><span class="line"></span><br><span class="line">class Pipeline</span><br><span class="line">&#123;</span><br><span class="line">    protected $pipes, $kernel;</span><br><span class="line"></span><br><span class="line">    public function send(Kernel $kernel)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;kernel = $kernel;</span><br><span class="line"></span><br><span class="line">        return $this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function through($pipes)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;pipes = $pipes;</span><br><span class="line"></span><br><span class="line">        return $this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function then(Closure $destination)</span><br><span class="line">    &#123;</span><br><span class="line">        return array_reduce($this-&gt;pipes, $this-&gt;carry(), $this-&gt;dispatchRouter($destination));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function carry()</span><br><span class="line">    &#123;</span><br><span class="line">        return function ($stack, $pipe) &#123;</span><br><span class="line"></span><br><span class="line">            return function ($passable) use ($stack, $pipe) &#123;</span><br><span class="line"></span><br><span class="line">                if ($pipe instanceof Closure) &#123;</span><br><span class="line">                    return $pipe($passable, $stack);</span><br><span class="line">                &#125; elseif (!is_object($pipe)) &#123;</span><br><span class="line">                    $pipe = new $pipe;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                return $pipe-&gt;handle($passable, $stack);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function dispatchRouter($destination)</span><br><span class="line">    &#123;</span><br><span class="line">        return function ($passable) use ($destination) &#123;</span><br><span class="line">            $destination($passable);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类就是用来处理中间件逻辑的地方，具体逻辑与前文“对口令游戏”一样。</p>
<p>这个类通过 send 方法接收上面封装好的 Http 核心类 Kernel，</p>
<p>Kernel 类具有获取请求参数和返回响应的权限，它会被传到中间件里。</p>
<blockquote>
<p>中间件要根据请求参数判断是否符合条件，在中间件还可以直接返回响应</p>
</blockquote>
<p>中间件的逻辑类也完成了，接下来就要修改 RouteParams 解析路由实例化控制器的地方。</p>
<p>将原来创建控制器实例的方法抽取出来，封装为 routeResponse：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 执行路由响应</span><br><span class="line">* @return \Closure</span><br><span class="line">*/</span><br><span class="line">protected function routeResponse()</span><br><span class="line">&#123;</span><br><span class="line">    return function ($kernel) &#123;</span><br><span class="line"></span><br><span class="line">        // 实例化类</span><br><span class="line">        $controllerName = $this-&gt;getFullControllerName();</span><br><span class="line">        $controllerObject = new $controllerName($kernel);</span><br><span class="line">        $this-&gt;uri = rtrim($this-&gt;request-&gt;server[&#x27;request_uri&#x27;], &#x27;/&#x27;);</span><br><span class="line"></span><br><span class="line">        $params = $this-&gt;getRouteParams();</span><br><span class="line"></span><br><span class="line">        // 执行方法时，路径参数作为方法的参数</span><br><span class="line">        call_user_func_array([$controllerObject, $this-&gt;action], $params);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法返回的是一个闭包，也就是说返回值是一个匿名函数。</p>
<p>接下来修改原来的 createResponse 方法，现在可以直接实例化 PipeLine 来调用中间件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * 执行路由</span><br><span class="line">    * @param $request</span><br><span class="line">    * @param $response</span><br><span class="line">    */</span><br><span class="line">public function createResponse($request, $response)</span><br><span class="line">&#123;</span><br><span class="line">    // 判断请求方法是否正确</span><br><span class="line">    if ($this-&gt;method != RequestMethod::ANY &amp;&amp; $request-&gt;server[&#x27;request_method&#x27;] != $this-&gt;method) &#123;</span><br><span class="line">        (new MethodErrorResponse())-&gt;response($request, $response, $this);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 判断方法是否存在</span><br><span class="line">    $controllerName = $this-&gt;getFullControllerName();</span><br><span class="line">    if (!class_exists($controllerName)) &#123;</span><br><span class="line">        (new ClassNotFoundResponse())-&gt;response($request, $response, $this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $action = $this-&gt;action;</span><br><span class="line"></span><br><span class="line">    // 不存在方法则返回404</span><br><span class="line">    if (!method_exists($controllerName, $action)) &#123;</span><br><span class="line">        (new ActionNotFoundResponse())-&gt;response($request, $response, $this);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $this-&gt;request = $request;</span><br><span class="line">    $this-&gt;response = $response;</span><br><span class="line"></span><br><span class="line">    // 测试用</span><br><span class="line">    $pipes = [&#x27;App\\middleware\\TestMiddlewareA&#x27;, &#x27;App\\middleware\\TestMiddlewareB&#x27;];</span><br><span class="line"></span><br><span class="line">    $pipeline = new Pipeline();</span><br><span class="line"></span><br><span class="line">    $kernel = new Kernel(new Request($request, $this), new Response($response));</span><br><span class="line"></span><br><span class="line">    $routeResponse = $pipeline-&gt;send($kernel)</span><br><span class="line">        -&gt;through(array_reverse($pipes))</span><br><span class="line">        -&gt;then($this-&gt;routeResponse());</span><br><span class="line"></span><br><span class="line">    $routeResponse($kernel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$pipes = [&#x27;App\\Middleware\\TestMiddlewareA&#x27;, &#x27;App\\middleware\\TestMiddlewareB&#x27;];</span><br></pre></td></tr></table></figure>

<p>手动声明了两个中间件，然后访问任意路由就可以看到中间件的效果了。</p>
<p>测试之后发现中间件正常运行。</p>
<h3 id="添加映射关系"><a href="#添加映射关系" class="headerlink" title="添加映射关系"></a>添加映射关系</h3><p>框架现在没有中间件名称和类名的映射关系，所以才只能用上面的测试代码来调试。</p>
<p>接下来创建一个配置中间件映射关系的文件，在博客目录下创建 app&#x2F;Middleware&#x2F;Kernel.php：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Middleware;</span><br><span class="line"></span><br><span class="line">class Kernel</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * 实例化的中间件</span><br><span class="line">     *</span><br><span class="line">     * @var [Middleware]</span><br><span class="line">     */</span><br><span class="line">    protected static $instances;</span><br><span class="line"></span><br><span class="line">    protected static $middlewares = [</span><br><span class="line">        &#x27;a&#x27; =&gt; TestMiddlewareA::class,</span><br><span class="line">        &#x27;b&#x27; =&gt; TestMiddlewareB::class,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    public static function getMiddlewareInstance($name)</span><br><span class="line">    &#123;</span><br><span class="line">        // 从已实例化的对象数组中取</span><br><span class="line">        if(isset(self::$instances[$name])) &#123;</span><br><span class="line">           return self::$instances[$name]; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 未实例化的创建新对象</span><br><span class="line">        $middlewareName = self::$middlewares[$name] ?? null;</span><br><span class="line"></span><br><span class="line">        if($middlewareName == null) &#123;</span><br><span class="line">            self::$instances[$name] = null;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            self::$instances[$name] = new $middlewareName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return self::$instances[$name];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我用一个静态变量来保存实例化的中间件，因为中间件的对象是固定的，</p>
<p>没必要每次调用的时候都重新创建一次，一旦实例化之后就直接放进内存，这样可以提高效率。</p>
<p>这样就完成整个中间件的功能了。</p>
<h2 id="测试中间件"><a href="#测试中间件" class="headerlink" title="测试中间件"></a>测试中间件</h2><p>编辑 web.php，添加两个测试路由：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$router = new \FireRabbitEngine\Module\Route\Router();</span><br><span class="line"></span><br><span class="line">$router-&gt;setConfig([</span><br><span class="line"></span><br><span class="line">    &#x27;namespace&#x27; =&gt; &#x27;App\\Controller\\Home\\&#x27;,</span><br><span class="line">    &#x27;middleware&#x27; =&gt; [&#x27;a&#x27;]</span><br><span class="line"></span><br><span class="line">])-&gt;group(function () use ($router) &#123;</span><br><span class="line"></span><br><span class="line">    // 这个路由的中间件为：[auth, other]</span><br><span class="line">    $router-&gt;get(&#x27;/user&#x27;, &#x27;IndexController@index&#x27;)-&gt;middleware([&#x27;b&#x27;]);</span><br><span class="line"></span><br><span class="line">    // 这个路由的中间件为：[auth]</span><br><span class="line">    $router-&gt;get(&#x27;/admin&#x27;, &#x27;IndexController@index&#x27;);</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">return $router;</span><br></pre></td></tr></table></figure>

<p>通过访问上述定义的路由，然后修改 a 和 b 参数的值即可看到中间件的拦截功能。</p>
<h2 id="修改记录"><a href="#修改记录" class="headerlink" title="修改记录"></a>修改记录</h2><h3 id="中间件配置化"><a href="#中间件配置化" class="headerlink" title="中间件配置化"></a>中间件配置化</h3><p>修改时间：2020-02-13 22:47</p>
<p>突然发现 PipeLine 方法调用 Kernel 类十分不合理。</p>
<p>框架的代码不应该依赖项目的代码，因此需要优化。</p>
<p>在 app&#x2F;config 目录下创建 middleware.php 用来保存中间件的名称映射关系：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">return [</span><br><span class="line">    &#x27;a&#x27; =&gt; App\Middleware\TestMiddlewareA::class,</span><br><span class="line">    &#x27;b&#x27; =&gt; App\Middleware\TestMiddlewareB::class,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>接着将原本放在 app&#x2F;Middleware 下面的 Kernel 删掉，</p>
<p>并且在框架 module&#x2F;Http 目录新建一个 Middleware 目录，将 Middleware.php 移到这个目录下。</p>
<p>同时重新创建一个 Kernel 类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace FireRabbitEngine\Module\Http\Middleware;</span><br><span class="line"></span><br><span class="line">class Kernel</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * 实例化的中间件</span><br><span class="line">     *</span><br><span class="line">     * @var [Middleware]</span><br><span class="line">     */</span><br><span class="line">    protected static $instances;</span><br><span class="line"></span><br><span class="line">    protected static $middlewares = [];</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 读取配置文件</span><br><span class="line">     * @param $middlewares</span><br><span class="line">     */</span><br><span class="line">    public static function setConfig($middlewares)</span><br><span class="line">    &#123;</span><br><span class="line">        self::$middlewares = $middlewares;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static function getMiddlewareInstance($name)</span><br><span class="line">    &#123;</span><br><span class="line">        // 从已实例化的对象数组中取</span><br><span class="line">        if (isset(self::$instances[$name])) &#123;</span><br><span class="line">            return self::$instances[$name];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 未实例化的创建新对象</span><br><span class="line">        $middlewareName = self::$middlewares[$name] ?? null;</span><br><span class="line"></span><br><span class="line">        if ($middlewareName == null) &#123;</span><br><span class="line">            self::$instances[$name] = null;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            self::$instances[$name] = new $middlewareName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return self::$instances[$name];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>中间件的配置不再直接写在这个类里，而是通过 <code>setConfig</code> 读取配置参数。</p>
<p>接着在修改文件 http_server.php，加入一行代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\FireRabbitEngine\Module\Http\Middleware\Kernel::setConfig(require &#x27;./app/config/middleware.php&#x27;);</span><br></pre></td></tr></table></figure>

<p>这样框架和项目之间就不再有直接的依赖关系了。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">火烧兔子</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://huotublog.com/2021/02/12/my-swoole-framework-8/">http://huotublog.com/2021/02/12/my-swoole-framework-8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP/">PHP</a><a class="post-meta__tags" href="/tags/FireRabbitEngine/">FireRabbitEngine</a><a class="post-meta__tags" href="/tags/Swoole/">Swoole</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/02/13/my-swoole-framework-9/"><i class="fa fa-chevron-left">  </i><span>从零开始搭建自己的Swoole框架（九）视图blade模板</span></a></div><div class="next-post pull-right"><a href="/2021/02/11/my-swoole-framework-7/"><span>从零开始搭建自己的Swoole框架（七）路由动态注入参数</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://i.loli.net/2021/05/02/61DLs9VHetxbq2n.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By 火烧兔子</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>